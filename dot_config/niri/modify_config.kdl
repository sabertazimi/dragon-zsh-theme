#!/usr/bin/env bash

# Idempotent niri config.kdl modifier
# Usage: cat ~/.config/niri/config.kdl | ./modify_config.kdl > ~/.config/niri/config.kdl.new

# Read entire content from stdin
content=$(cat)

# Helper function to check if a line exists in content
line_exists() {
    local line="$1"
    echo "$content" | grep -qF -- "$line"
}

# 1. Replace scope="output" with scope="all"
content=$(echo "$content" | sed 's/scope="output"/scope="all"/g')

# 2. Add QT environment variables
if ! line_exists 'QT_QPA_PLATFORMTHEME "qt6ct"'; then
    content=$(awk '
        /^[[:space:]]*environment[[:space:]]*{/ && !qt_added {
            print
            print "  QT_QPA_PLATFORMTHEME \"qt6ct\""
            print "  QT_QPA_PLATFORMTHEME_QT6 \"qt6ct\""
            qt_added = 1
            next
        }
        { print }
    ' <<< "$content")
fi

# 3. Add locale environment variables
if ! line_exists 'LC_CTYPE "en_US.UTF-8"'; then
    content=$(awk '
        /^[[:space:]]*environment[[:space:]]*{/ && !locale_added {
            print
            print "  LC_CTYPE \"en_US.UTF-8\""
            print "  XMODIFIERS \"@im=fcitx\""
            print "  LANG \"zh_CN.UTF-8\""
            locale_added = 1
            next
        }
        { print }
    ' <<< "$content")
fi

# 4. Add fcitx5 spawn-at-startup
if ! line_exists 'spawn-at-startup "fcitx5" "-d"'; then
    if echo "$content" | grep -q 'spawn-at-startup'; then
        content=$(awk '
            /spawn-at-startup.*"fcitx5"/ { fcitx_seen = 1 }
            /spawn-at-startup/ && !fcitx_seen && !fcitx_added {
                print
                print "spawn-at-startup \"fcitx5\" \"-d\""
                fcitx_added = 1
                next
            }
            { print }
        ' <<< "$content")
    else
        # Add after environment block
        content=$(awk '
            /^[[:space:]]*environment[[:space:]]*{/ {
                in_env = 1
            }
            in_env && /^[[:space:]]*}/ && !fcitx_added {
                print
                print "spawn-at-startup \"fcitx5\" \"-d\""
                print ""
                fcitx_added = 1
                in_env = 0
                next
            }
            { print }
        ' <<< "$content")
    fi
fi

# 5. Add rclone onedrive mount spawn-at-startup
if ! line_exists 'spawn-at-startup "rclone"'; then
    if echo "$content" | grep -q 'spawn-at-startup'; then
        content=$(awk '
            /spawn-at-startup.*"rclone"/ { rclone_seen = 1 }
            /spawn-at-startup.*"fcitx5"/ && !rclone_seen && !rclone_added {
                print
                print "spawn-at-startup \"rclone\" \"mount\" \"onedrive:/\" \"/home/sabertaz/onedrive\" \"--vfs-cache-mode\" \"full\" \"--daemon\""
                rclone_added = 1
                next
            }
            { print }
        ' <<< "$content")
    fi
fi

# Output modified content
echo "$content"
